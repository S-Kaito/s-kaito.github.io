<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="style.css">
	<script type="text/javascript" src="script.js" defer></script>
	<title>[5]実装(退化・ループ閉じ込み) - SLAM入門</title>
</head>
<body>
	<div class="wrapper">
		<div class="title">実装(退化・ループ閉じ込み)</div>
		<div class="item">
			<div class="item-title">退化</div>
			<div class="item-desc">
				退化は環境形状が単純な時に生じやすくなる。例えば、廊下などの平行線ではスキャンマッチングを点群データからでは分からず退化が起こる。そのため、退化への対策を講じる必要がある。そのための有効な手法として別のセンサを用いる方法がある。移動ロボットｐにおいて最も一般的なのはオドメトリを併用することが挙げられる。このように、複数のセンサ情報を組み合わせることを「センサ融合」と言う。
				<div class="figure">
					<img src="pic/implement05.png" alt="">
					<div class="figure-text">図01 退化</div>
				</div>

				<b>センサ融合</b>は一言でいうと「複数センサによる推定値の平均をとる」こと。その際、センサデータの信頼性に基づいた重みを付けて平均を取る。下の図ではスキャンマッチングの推定値の分布とオドメトリの推定値の分布を表している。レーザスキャナには2枚の壁しか見えないので、スキャンマッチングによるロボット位置の推定値は図の様に長い分布になる。一方、オドメトリの推定値は小さな楕円に収まる。この二つの推定値を融合すると黒丸の位置に推定値が得られる。これは両者の分布による「重み」に応じて配分された位置である。<br>
				重みとして良く用いられるのは<b>共分散</b>である。共分散はデータや推定値のばらつき具合を示す値で、任意の確率分布で定義できるが、ここでは正規分布を用いる。<b>正規分布</b>は多くの誤差分布に当てはまり、しかも平均と共分散の2つのパラメータだけで表現できるので計算がしやすい。
				<div class="figure">
					<img src="pic/implement06.png" alt="">
					<div class="figure-text">図02 センサ融合</div>
				</div>

				正規分布は下記の式により融合できる。では、それぞれの共分散の計算方法について述べる。
				<img src="pic/implement_formula04.png" alt=""><br>

				<div class="item-subtitle">スキャンマッチングによるロボット位置の共分散</div>
				スキャンマッチングにおける共分散は、マッチングの不確実性を表します。多次元の場合、ある軸では不確実性が大きく、別の軸では小さいということがある。廊下などの長い通路での退化がその一例である。<br>
				スキャンマッチングの共分散の計算方法はいくつか提案されているが、今回はラプラス近似に基づく方法を採用する。<b>ラプラス近似</b>は確率密度関数の最大値付近の形状を正規分布で近似する方法。
				<ul>
					<li>極小値x_0を平均とする</li>
					<li>極小値x_0におけるヘッセ行列の逆行列の定数倍を共分散とする</li>
				</ul>
				(ただし、ICPのコスト関数(確率密度の負の対数に相当)に適応するため、最大値を最小値に置き換える)<br>
				<br>
				これをICPに適応するには、ICPのコスト関数の極小値におけるヘッセ行列を求める必要がある。これには二つの事に気を付ける。<br>
				<ul>
					<li>
						<b>点の対応付けの曖昧性をどう扱うか？</b><br>
						対応付けの曖昧さは計算に反映されない。点間距離によるコスト関数ではそれが間違いでも共分散が小さくなってしまう。対策としては垂直距離を用いることがあり、これだと環境が滑らかならば大きく変わらない。
					</li>
					<li>
						<b>計算が複雑である</b><br>
						ヘッセ行列は多変数関数の２次微分であり、そのため計算が複雑である。そこで、ヘッセ行列の直接計算を回避するために、<b>ガウス-ニュートン近似</b>を用いる。これはヘッセ行列Hをヤコビ行列Jの積で表すもので、極地の近傍で成り立つ。
					</li>
				</ul>

				<div class="item-subtitle">オドメトリによるロボット位置の共分散</div>
				オドメトリの共分散の計算には速度運動モデルがよく用いられる。ただし、今回は簡単のために手軽な手法を用いる。<br>
				共分散行列の対角成分だけを計算し、他の成分は０とする。対角成分は並進成分と回転成分の分散を表す。
			</div>
		</div>

		<div class="item">
			<div class="item-title">ループ閉じ込み</div>
			<div class="item-desc">
				<div class="item-subtitle">ループ閉じ込み</div>
				<b>ループ閉じ込み</b>とは、周回して同じ場所に戻ったことを検出して、その位置を合わせてループを閉じるようにすることである。SLAMの累積誤差を減らすことが出来る。ループ閉じ込みは以下の手順で行う。
				<ol>
					<li>
						<b>ループ検出</b><br>
						<b>再訪点</b>(それまでの走行の中で音連れた領域の中で、現在位置に相当する点)に来たことを検出する。スキャンマッチングを行い、前回訪問時のロボット位置V0、現在のロボット位置V1との相対位置からマッチングさせる。
					</li>
					<li>
						<b>ポーズ調整</b><br>
						検出された再訪点を通るようにロボット軌跡を修正する。これを<b>ポーズ調整</b>と言い、ポーズグラフの持つ残差が最小化するように最適化することで実現できる。
					</li>
					<li>
						<b>地図の修正</b><br>
						ポーズ調整で修正されたロボット軌跡に沿って、地図の点群を再配置する。
					</li>
				</ol>

				<div class="item-subtitle">ポーズ調整</div>
				<b>ポーズグラフ</b>とは、ロボット軌跡をグラフ構造で表したもので、ロボット位置を<b>頂点</b>、ロボット位置間の相対位置を<b>辺</b>で表す。辺にはオドメトリ辺とループ辺があり、<b>オドメトリ辺</b>は時刻t-1からtまでの移動量を示し、ループ辺はループ検出時に生成される辺で、時間的に離れた頂点間を結ぶ。

				
				<div class="figure">
					<img src="pic/implement07.png" alt="">
					<div class="figure-text">図03 ポーズグラフの例</div>
				</div>

				<div class="item-subtitle">ポーズグラフの最適化</div>
				ポーズ調整は次のように定式化されます。<br>
				<img src="pic/implement_formula05.png" alt=""><br>
				x_t: 時刻tのロボット位置<br>
				f(a, b): ロボット位置a, bの相対位置を求める<br>
				d_t: x_t-1, x_tの間の辺の拘束<br>
				C: ループ辺の集合<br>
				d_st: x_s, x_tの間の辺の拘束<br>
				\Sigma_t: d_tの共分散<br>
				\Sigma_st: d_stの誤差共分散<br>
				この式は、辺の両頂点の相対位置屠蘇の拘束との二乗距離の和になっており、共分散による重みがついている。これは辺の拘束と頂点のずれを表しており、Jが小さいほどずれが小さく、ポーズグラフの整合性が取れているといえる。<br>
				この最小化は非線形最小二乗問題であり、ガウス-ニュートン法やレーベンバーグ-マーカート法を用いて説くことになります。

				<div class="item-subtitle">部分地図の導入</div>
				ループ検出をするために、地図表現を工夫する。これまでは、地図の点群を１つのコンテナ格子テーブルに格納していたが、それでは次の問題が発生する。
				<ul>
					<li>処理時間がかかる</li>
					<li>検出誤りが増える</li>
					<li>地図の歪みによる重複部分でのマッチング</li>
				</ul>
				そこで、本書では地図を分割した<b>部分地図</b>を作る。
				<div class="figure">
					<img src="pic/implement08.png" alt="">
					<div class="figure-text">図04 部分地図の例</div>
				</div>

				<div class="item-subtitle">ループ検出</div>
				<b>ループ検出</b>ではロボットが同じ場所に戻ってきたことを検出して再訪点をみつけ、ポーズグラフにループ辺を追加する。まず、再訪点候補を求める。これは現在位置から一定の範囲内の点を再訪点の候補とする。次に、現在位置から一番近い点を再訪点候補として絞り込む。最後に、周囲形状と現在スキャンとでスキャンマッチングを行って再訪点の位置を確定する。

				<div class="item-subtitle">地図の修正</div>
				ポーズ調整で新しいロボット位置が求まれば、それに沿って点群を再配置することで地図が修正される。ここで問題となるのは地図を構成する点はもはやスキャン点ではなく、複数のスキャン点の代表であること(格子テーブルによる点の削減を行ったため)がある。そこで、格子テーブルに登録する点にはスキャン番号をつけておく。
			</div>
		</div>
		
		<div class="item">
			<div class="item-title">まとめ</div>
			<div class="item-desc">
				ここまでの流れを用いることで退化・ループ閉じ込みが組み込まれ、2D-SLAMプログラムが完成した。しかし、実世界では実に様々なことが起こる。例えば、確率分布に従わない誤差・車輪のスリップ・大量の移動障害物などがある。<br>
				実世界は多様であり、このようなことが当たり前に起こる。SLAMは地図と自己位置推定が相互に依存するため不安定性が増大しやすい性質を持つ。しかし、多様な実世界でロバスト性を実現するのは非常に面白い課題でしょう。<br><br>
				<div style="text-align: right; color: #555"><i>――――SLAM入門</i></div>
			</div>
		</div>

	</div>
</body>
</html>